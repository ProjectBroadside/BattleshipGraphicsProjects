# Architectural Code Review Report

This report was generated by first reading the project's official architectural documents, then summarizing each code file, and finally comparing the implementation against the plan.

---

## Part 1: Architectural Analysis (Plan vs. Reality)

# Project Broadside Code Review Report

## Architectural Compliance Check

### Separation of Concerns

- **DOTS Layer:**
  - **Physics and Core Systems:** The provided summaries show that the physics-related components like `BuoyancyQueryState`, `BuoyancyConfig`, `BuoyancyQueryResult`, etc., are correctly placed in the DOTS layer. These structures implement `IComponentData` or related interfaces, indicating they belong to the DOTS/ECS system.
  - **Projectile and Object Pooling:** The `PoolManager.cs` class seems correctly placed in the MonoBehaviour layer, but it uses components from the DOTS layer (e.g., `Unity.Entities`). However, this is a common practice where MonoBehaviours can manage DOTS entities.

- **MonoBehaviour Layer:**
  - **Gameplay Logic and UI:** Classes like `ReplayUI` are clearly placed in the MonoBehaviour layer. This aligns with handling high-level game logic and presentation.
  
### Bridge Systems

- **FireControlBridgeSystem:** Not explicitly mentioned in the summaries, but it appears that there is a mechanism to handle fire requests via `FireRequestQueue`. While this queue exists, the actual implementation of `FireControlBridgeSystem` is missing from the summaries. The presence of `FireRequestQueue` suggests this should be implemented.
  
- **ImpactEventBridgeSystem:** Similarly, the `ImpactEventBridgeSystem` is not mentioned in the provided summaries. There is a mention of a `DamageReceiver` being part of MonoBehaviours which implies that some form of bridge system must exist to communicate collision events from DOTS to MonoBehaviours.

### EntityProxy & ProxyManager

- **Entity Synchronization:** No explicit reference to `EntityProxy` and `ProxyManager` systems in the provided summaries. Given the description, this is a critical piece missing for synchronizing between DOTS entities and GameObjects. This needs implementation based on architectural documentation.

## Plan vs. Reality Discrepancy Report

### Missing Systems or Features from Code Summaries

- **FireControlBridgeSystem:** Not present; necessary to handle firing requests from MonoBehaviours in the DOTS layer.
- **ImpactEventBridgeSystem:** Not present; required for detecting collision events in DOTS and passing them to MonoBehaviour `DamageReceiver`.
- **EntityProxy & ProxyManager:** Not present; critical for mapping DOTS entities back to GameObjects.

### Implemented Systems Not Described in Documentation

- **ReplayUI.cs:** While mentioned in the documentation, no specific details about this UI component were provided. This is an expected part of gameplay logic/UI.
- **PoolManager.cs:** The existence of a pool manager aligns with both core physics and projectile/object pooling, but itâ€™s not explicitly detailed in the documentation.

## Dependency & Namespace Sanity Check

### Obvious Dependency Issues

- There are no apparent dependency issues based on the summaries. However, the lack of `FireControlBridgeSystem` and `ImpactEventBridgeSystem` implementations implies missing dependencies that would tie the DOTS and MonoBehaviour layers together.
  
### High-Level Namespace Inconsistencies

- No high-level namespace inconsistencies observed from the provided summaries. The usage of Unity namespaces (e.g., `Unity.Entities`, `Unity.Collections`) is consistent with their intended use cases.

## Recommendations

1. **Implement Missing Bridge Systems:**
   - Implement `FireControlBridgeSystem` to handle firing requests and spawn projectile entities in the DOTS layer.
   - Implement `ImpactEventBridgeSystem` to detect collision events in the DOTS layer and pass them to MonoBehaviours for damage processing.

2. **Implement ProxyManager Pattern:**
   - Develop `EntityProxy` and `ProxyManager` systems to synchronize DOTS entities with GameObjects, ensuring both layers remain in sync.

3. **Documentation Updates:**
   - Update documentation to include details about the `ReplayUI.cs` component and other implemented features not explicitly detailed.
   - Ensure all planned bridge systems are documented for clarity.

4. **Code Reviews:**
   - Conduct thorough code reviews to ensure adherence to the hybrid DOTS/MonoBehaviour architecture, particularly focusing on separation of concerns and communication between layers.

---

By addressing these points, Project Broadside can better align its implementation with its architectural documentation, ensuring a robust and efficient game engine structure.

---

## Part 2: Knowledge Agent Research Task

The following question was synthesized from the analysis for further research by a knowledgeable AI assistant.

### Research Question

**To Knowledge Agent:**

The architectural review report identifies several critical discrepancies and missing systems in Project Broadside's implementation. Specifically, the absence of `FireControlBridgeSystem`, `ImpactEventBridgeSystem`, and `EntityProxy` & `ProxyManager` is highlighted as essential for aligning with the hybrid DOTS/MonoBehaviour architecture. These bridge systems are crucial for handling communication between the DOTS layer and MonoBehaviour layer.

#### Core Problem or Discrepancy:

**From Architect's Analysis:**
- **"FireControlBridgeSystem:** Not present; necessary to handle firing requests from MonoBehaviours in the DOTS layer."
- **"ImpactEventBridgeSystem:** Not present; required for detecting collision events in DOTS and passing them to MonoBehaviours for damage processing."
- **"EntityProxy & ProxyManager:** Not present; critical for mapping DOTS entities back to GameObjects."

#### Relevant Code Snippets:

1. **FireRequestQueue.cs:**
   ```csharp
   public static class FireRequestQueue
   {
       private static ConcurrentQueue<FireRequest> _queue = new ConcurrentQueue<FireRequest>();

       public static void Enqueue(FireRequest request)
       {
           _queue.Enqueue(request);
       }

       public static bool TryDequeue(out FireRequest request)
       {
           return _queue.TryDequeue(out request);
       }

       public static int Count => _queue.Count;
   }
   ```

2. **BuoyancyComponents.cs:**
   ```csharp
   public struct BuoyancyQueryState : IComponentData { }
   public struct BuoyancyConfig : IComponentData { }
   public struct BuoyancyQueryResult : IBufferElementData { }
   public struct BuoyancyPoints : IComponentData { }
   ```

3. **PoolManager.cs:**
   ```csharp
   public class PoolManager : MonoBehaviour
   {
       void Start()
       {
           StartCoroutine(CreateProjectilePoolCoroutine());
       }

       private IEnumerator CreateProjectilePoolCoroutine()
       {
           // Coroutine logic to create projectile pool.
       }
   }
   ```

#### Research Request:

1. **Detailed Explanation:**
   - Please provide a detailed explanation of how the `FireControlBridgeSystem` should be implemented using the existing `FireRequestQueue`. Include an example of how this system would interact with other components such as `FireControlComponent`.

2. **Best-Practice Recommendation:**
   - Recommend best practices for implementing the `ImpactEventBridgeSystem` to handle collision events in the DOTS layer and pass them to MonoBehaviours, particularly focusing on integrating with systems like `DamageReceiver`.

3. **Proposed Code Modification:**
   - Propose a concrete implementation of `EntityProxy` & `ProxyManager` systems that synchronize DOTS entities with GameObjects. Include code examples demonstrating how these systems would work within the existing architecture.

By addressing these points, Project Broadside can ensure better alignment between its architectural documentation and implementation, leading to a more robust and efficient game engine structure.

---

## Part 3: Individual File Summaries (For Reference)

The following summaries were used as the context for the above analysis:

--- Summary for .Replay\ReplayUI.cs ---
### Summary of `ReplayUI.cs`

#### Defined Classes, Structs, and Interfaces:
- **Class:** `ReplayUI` (inherits from `MonoBehaviour`)

#### Public Functions/Methods:
- `ShowReplayUI()`
- `HideReplayUI(bool immediate = false)`
- `IsUIVisible` (property)
- `ReplayCanvas` (property)
- `ReplayDisplay` (property)

#### Significant `using` Statements:
- `using UnityEngine;`
- `using UnityEngine.UI;`

--- Summary for Components\FireControlComponents.cs ---
- **Classes, Structs, and Interfaces:**
  - `struct FireControlComponent` (implements `IComponentData`)

- **Public Functions/Methods:**
  - None

- **Significant `using` Statements:**
  - `using Unity.Entities;`

--- Summary for Components\ProjectileComponents.cs ---
### Summary of `Components\ProjectileComponents.cs`

- **Classes, Structs, and Interfaces:**
  - `struct ActiveProjectileTag : IComponentData`
  - `struct PooledProjectileTag : IComponentData`
  - `struct BallisticProperties : IComponentData`

- **Public Functions/Methods:**
  - None

- **Significant Using Statements:**
  - `using Unity.Entities;`

--- Summary for Components\TorpedoComponents.cs ---
- **Defined Classes, Structs, and Interfaces:**
  - `struct ActiveTorpedoTag` implementing `IComponentData`
  - `struct TorpedoProperties` implementing `IComponentData`

- **Public Functions/Methods:**
  - None

- **Significant `using` Statements:**
  - `using Unity.Entities;`

--- Summary for Core\PoolManager.cs ---
### Summary of `Core\PoolManager.cs`

#### Defined Classes, Structs, and Interfaces:
- **Classes:**
  - `PoolManager` (Inherits from `MonoBehaviour`)

#### Public Functions/Methods:
- `void Start()`
- `IEnumerator CreateProjectilePoolCoroutine()` *(Note: This is not public, but it's the main coroutine used for creating the projectile pool.)*

#### Significant `using` Statements:
- `using UnityEngine;`
- `using Unity.Entities;`
- `using Unity.Collections;`
- `using System.Collections;`
- `using Unity.Transforms;`
- `using Unity.Physics.Systems;`
- `using Unity.Physics;`

--- Summary for Queues\CommandType.cs ---
- **Defined Classes, Structs, and Interfaces:**
  - `CommandType` (enum)

- **Public Functions/Methods:**
  - None

- **Significant `using` Statements for External Dependencies:**
  - None

--- Summary for Queues\FireRequestQueue.cs ---
### Summary of `Queues\FireRequestQueue.cs`

#### Defined Classes, Structs, and Interfaces:
- **Struct**: `FireRequest`
- **Static Class**: `FireRequestQueue`

#### Public Functions/Methods:
- `Enqueue(FireRequest request)`
- `TryDequeue(out FireRequest request)`
- `Count` (property)

#### Significant `using` Statements:
- `using System.Collections.Concurrent;`
- `using Unity.Entities;`
- `using ProjectBroadside;`

--- Summary for Queues\ShipCommandQueue.cs ---
- **Classes, Structs, and Interfaces:**
  - `ShipCommand` (struct)
  - `ShipCommandQueue` (static class)

- **Public Functions/Methods:**
  - `Enqueue(ShipCommand command)`
  - `TryDequeue(out ShipCommand command)`
  - `int Count { get; }`

- **Significant `using` Statements:**
  - `using System.Collections.Concurrent;`
  - `using Unity.Entities;`

--- Summary for Systems\Physics\BuoyancyComponents.cs ---
### Summary of `Systems\Physics\BuoyancyComponents.cs`

#### Defined Classes, Structs, and Interfaces:
- **Structs:**
  - `BuoyancyQueryState` (implements `IComponentData`)
  - `BuoyancyConfig` (implements `IComponentData`)
  - `BuoyancyQueryResult` (implements `IBufferElementData`)
  - `BuoyancyPoints` (implements `IComponentData`)
  - `BuoyancyPointsBlob`

#### Public Functions/Methods:
- **No public functions/methods are defined in this file.**

#### Significant `using` Statements:
- `using Unity.Entities;`
- `using Unity.Mathematics;`
